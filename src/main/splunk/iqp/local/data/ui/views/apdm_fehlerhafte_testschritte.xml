<form script="apdm_fehlerhafte_testschritte/js/db_apdm_fehlerhafte_testschritte.js">
  <init>
    <set token="i18n_testStepStart" i18ntag="">Testschrittstart</set>
    <set token="i18n_shortVIN">FGNR</set>
    <set token="i18n_pruefumfangName" i18ntag="">Pruefumfang</set>
    <set token="i18n_sequenceNrResult" i18ntag="">SeqNr</set>
    <set token="i18n_testStepName" i18ntag="">Pruefling</set>
    <set token="i18n_pruefprozedurName" i18ntag="">Prüfprozedur</set>
    <set token="i18n_description" i18ntag="">Beschreibung</set>
    <set token="i18n_param1" i18ntag="">SGBD</set>
    <set token="i18n_param2" i18ntag="">API-Job</set>
    <set token="i18n_param3" i18ntag="">Parameter API-Job</set>
    <set token="i18n_testStepResult" i18ntag="">Ergebnis</set>
    <set token="i18n_Error_Code_Dec">Error Code (Dec)</set>
    <set token="i18n_Error_Code_Hex">Error Code (Hex)</set>
    <set token="i18n_resultData" i18ntag="">Result Data</set>
    <set token="i18n_errorText" i18ntag="">Fehlertext</set>
    <set token="i18n_adviseText" i18ntag="">Hinweistext</set>
    <set token="i18n_resultName" i18ntag="">Ergebnisname (API-Result)</set>
    <set token="i18n_resultValue" i18ntag="">Ergebniswert</set>
    <set token="i18n_minValueStr" i18ntag="">Min</set>
    <set token="i18n_maxValueStr" i18ntag="">Max</set>
  </init>
  <label>APDM Fehlerhafte Testschritte</label>
  <fieldset submitButton="false">
    <input type="time" token="tsdatum" searchWhenChanged="true">
      <label>Datum des Testschrittes</label>
      <default>
        <earliestTime>-7d</earliestTime>
        <latestTime>now</latestTime>
      </default>
    </input>
    <input type="multiselect" token="shortVIN" searchWhenChanged="true">
      <label>FGNR</label>
      <allowCustomValues>true</allowCustomValues>
      <valuePrefix>source=*</valuePrefix>
      <valueSuffix>*</valueSuffix>
      <delimiter> OR </delimiter>
      <choice value="">-</choice>
    </input>
    <input type="text" token="pruefumfangName">
      <label>Pruefumfang</label>
    </input>
    <input type="text" token="testStepName">
      <label>Pruefling</label>
    </input>
    <input type="text" token="description">
      <label>Pruefprozedur</label>
    </input>
    <input type="text" token="param1">
      <label>SGBD</label>
    </input>
    <input type="text" token="ErrorCodeDec">
      <label>Error Code (Dec)</label>
    </input>
    <input type="text" token="resultData">
      <label>Result Data</label>
    </input>
  </fieldset>
  <search id="search_base">
    <query>
<![CDATA[
| tstats count
    values(TestStepResult.testStepStart) as testStepStart
    values(TestStepResult.shortVIN) as shortVIN
    values(TestStepResult.pruefumfangName) as pruefumfangName
    values(TestStepResult.testStepName) as testStepName
    values(TestStepResult.pruefprozedurName) as pruefprozedurName
    values(TestStepResult.description) as description
    values(TestStepResult.param1) as param1
    values(TestStepResult.param2) as param2
    values(TestStepResult.param3) as param3
    values(TestStepResult.testStepResult) as testStepResult
    values(TestStepResult.ErrorCodeDec) as ErrorCodeDec
    values(TestStepResult.ErrorCodeHex) as ErrorCodeHex
    values(TestStepResult.resultData) as resultData
    values(TestStepResult.errorText) as errorText
    values(TestStepResult.adviseText) as adviseText
    values(TestStepResult.resultName) as resultName
    values(TestStepResult.minValueStr) as minValueStr
    values(TestStepResult.maxValueStr) as maxValueStr
    values(TestStepResult.resultValueStr) as resultValueStr
    values(TestStepResult.resultValueDbl) as resultValueDbl
  from datamodel=APDM_Fehler
  where ($shortVIN$) TestStepResult.testStepName="$testStepName$" TestStepResult.pruefumfangName="$pruefumfangName$" TestStepResult.description="$description$" TestStepResult.param1="$param1$" TestStepResult.ErrorCodeDec="$ErrorCodeDec$" TestStepResult.resultData="$resultData$" TestStepResult.param2="$param2$" TestStepResult.errorText="$errorText$"
  groupby source TestStepResult.sequenceNrResult
| rename TestStepResult.* as * | fields - source count
| sort _time sequenceNrResult
]]>
    </query>
    <earliest>$tsdatum.earliest$</earliest>
    <latest>$tsdatum.latest$</latest>
  </search>
  <search id="fehlerprotokoll_suche">
    <query>
<![CDATA[
index=apdm 
(sourcetype="apdm_test_step_result" testStepResult=NOK $shortVIN$ testStepName="$testStepName$" pruefumfangName="$pruefumfangName$" 
description="$description$"  param1="$param1$" ErrorCodeDec="$ErrorCodeDec$" resultData="$resultData$" param2="$param2$" errorText="$errorText$") OR
(sourcetype="apdm_test_result" $shortVIN$ pruefumfangName="$pruefumfangName$") 
| table sourcetype source _raw | rename _raw AS raw
| sort source sourcetype 
| stats list(raw) as raw count by source | where count>1

| nomv raw
| eval raw=if(match(raw, "</testInfo>\s*</testResult>\s*$"),raw,raw+"</testInfo></testResult>") | fields raw
]]>
    </query>
    <earliest>$tsdatum.earliest$</earliest>
    <latest>$tsdatum.latest$</latest>
  </search>
  <row>
    <panel>
      <title>Vorhandene Fehlerprotokolle</title>
      <html>
        <div id="fehlerprotokoll_view"/>
      </html>
    </panel>
    <panel>
      <title>Vorhandene Fehler</title>
      <table id="table_fehler">
        <search id="search_fehler" base="search_base">
          <query>
| eval resultValue=coalesce(resultValueStr,resultValueDbl) 
| fields - resultValueStr resultValueDbl 
| eval testStepStart = substr(testStepStart, 1, len(testStepStart)-3) 
| eval testStepStart = strftime(testStepStart, "%Y-%m-%dT%H:%M:%S.%3N")   
| rename
  testStepStart AS "$i18n_testStepStart$"
  shortVIN AS "$i18n_shortVIN$"
  pruefumfangName AS "$i18n_pruefumfangName$"
  sequenceNrResult AS "$i18n_sequenceNrResult$"
  testStepName AS "$i18n_testStepName$"
  pruefprozedurName AS "$i18n_pruefprozedurName$"
  description AS "$i18n_description$"
  param1 AS "$i18n_param1$" 
  param2 AS "$i18n_param2$"
  param3 AS "$i18n_param3$"
  testStepResult AS "$i18n_testStepResult$"
  ErrorCodeDec AS "$i18n_Error_Code_Dec$"
  ErrorCodeHex AS "$i18n_Error_Code_Hex$" 
  resultData AS "$i18n_resultData$"
  errorText AS "$i18n_errorText$"
  adviseText AS "$i18n_adviseText$"
  resultName AS "$i18n_resultName$"
  resultValue AS "$i18n_resultValue$"
  minValueStr AS "$i18n_minValueStr$"
  maxValueStr AS "$i18n_maxValueStr$"</query>
        </search>
        <option name="wrap">true</option>
        <option name="rowNumbers">false</option>
        <option name="drilldown">none</option>
        <option name="dataOverlayMode">none</option>
        <option name="count">10</option>
      </table>
      <event>
        <title>Komplette Fehlermeldungen</title>
        <search id="search_fehler_komplett">
          <query>index=apdm sourcetype="apdm_test_step_result"  testStepResult=NOK $shortVIN$ testStepName="$testStepName$" pruefumfangName="$pruefumfangName$" description="$description$"  param1="$param1$" ErrorCodeDec="$ErrorCodeDec$" resultData="$resultData$"
| fields
    testStepStart
    shortVIN
    pruefumfangName
    sequenceNrResult
    testStepName
    pruefprozedurName
    description
    param1
    param2
    param3
    testStepResult
    ErrorCodeDec
    ErrorCodeHex
    resultData
    errorText
    adviseText
    resultName
    resultValueStr
    minValueStr
    maxValueStr
    *</query>
          <earliest>$tsdatum.earliest$</earliest>
          <latest>$tsdatum.latest$</latest>
        </search>
        <option name="wrap">true</option>
        <option name="rowNumbers">0</option>
        <option name="dataOverlayMode">none</option>
        <option name="list.drilldown">outer</option>
        <option name="list.wrap">1</option>
        <option name="maxLines">20</option>
        <option name="raw.drilldown">outer</option>
        <option name="table.drilldown">none</option>
        <option name="table.wrap">1</option>
        <option name="type">raw</option>
        <option name="count">10</option>
        <fields>["host","source","sourcetype"]</fields>
      </event>
    </panel>
  </row>
  <row>
    <panel>
      <title>Nacharbeiten aus IPSQ</title>
      <table id="table_nacharbeiten">
        <search id="search_nacharbeiten">
          <query>tag=ipsq [| stats count | eval vin_help="$shortVIN$" | eval search=replace(vin_help,"source","Fahrgestellnummer") | table search] | table "Fahrgestellnummer","Baureihe Code","Typschluessel Nr","Sistufenr","Nacharbeitsdatum","Merkmal Bezeichnung","NA Fehlerort Bezeichnung","NA Fehlerart Bezeichnung","NA Fehlerlage Bezeichnung","NA Taetigkeit Bezeichnung","NA_Bemerkung","NA Nacharbeiter ID","NA Schicht Bezeichnung","NA Leist Kostenstelle Nr","NA Leist Meisterbereich Nr","NA Bel Kostenstelle Nr","NA Bel Meisterbereich Nr","NA Bel Produktionsbereich Nr","NA Nacharbeitsdauer","PR/NA Fehlertyp Bezeichnung","PR Fehlerprotokoll Teil 1","PR Fehlerprotokoll Teil 2","PR Fehlerprotokoll Teil 3","PR Fehlerprotokoll Teil 4","PR Station Nr","NA Station Bezeichnung","PR Pruef Nacharbeit BI","PR_Bemerkung","PR Pruefer ID","Pruefdatum","F1 Datum" | rename "NA Taetigkeit Bezeichnung" AS "NA Tätigkeit Bezeichnung" "PR Pruef Nacharbeit BI" AS "PR Prüf Nacharbeit BI" "PR Pruefer ID" AS "PR Prüfer ID" Pruefdatum AS "Prüfdatum" "Typschluessel Nr" AS "Typschlüssel Nr" "PR_Bemerkung" AS "PR Bemerkung" "NA_Bemerkung" AS "NA Bemerkung"</query>
          <earliest>$tsdatum.earliest$</earliest>
          <latest>$tsdatum.latest$</latest>
        </search>
        <option name="wrap">true</option>
        <option name="rowNumbers">false</option>
        <option name="dataOverlayMode">none</option>
        <option name="count">10</option>
        <option name="drilldown">row</option>
        <drilldown>
          <link>ipsq_recherche_nacharbeit?form.shortVIN=$row.Fahrgestellnummer$&amp;form.pruefdatum.earliest=$tsdatum.earliest$&amp;form.pruefdatum.latest=$tsdatum.latest$</link>
        </drilldown>
      </table>
    </panel>
  </row>
</form>