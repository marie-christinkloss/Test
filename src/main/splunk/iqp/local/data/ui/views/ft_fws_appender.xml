<form script="fws_appender/js/appender.js" stylesheet="fws_appender/css/step_marker.css">
  <init>
    <set token="i18n_Hinzufuegen" i18ntag="">Hinzufuegen</set>
    <set token="i18n_Bearbeiten" i18ntag="">Bearbeiten</set>
    <set token="i18n_Entfernen" i18ntag="">Entfernen</set>
    <set token="i18n_Teststand" i18ntag="">Pruefstand</set>
    <set token="i18n_Testzeit" i18ntag="">Testzeit</set>
    <set token="i18n_modifiziert" i18ntag="">modifiziert</set>
    <set token="i18n_Ergebnisname" i18ntag="">Ergebnisname</set>
    <set token="i18n_Ergebniswert" i18ntag="">Ergebniswert</set>
    <set token="i18n_Einheit" i18ntag="">Einheit</set>
    <set token="i18n_Manuell-Flag" i18ntag="">Manuell-Flag</set>
  </init>
  <label>FT FWS: Appender</label>
  <search id="filter">
    <query>| tstats count AS "count(TestResult)" from datamodel=APDM_TestResults where (nodename = TestResult) groupby TestResult.werk TestResult.shortVIN, TestResult.systemName, TestResult.pruefumfangName prestats=true
| rename 
  TestResult.werk AS werk
  TestResult.shortVIN AS shortVIN
  TestResult.systemName AS systemName 
  TestResult.pruefumfangName AS pruefumfangName
| fields werk shortVIN systemName pruefumfangName</query>
    <earliest>$tok_datetime.earliest$</earliest>
    <latest>$tok_datetime.latest$</latest>
  </search>
  <search id="tests">
    <query>| tstats values(TestStepResult.resultValueDbl) AS resultValueDbl values(TestStepResult.resultValueStr) AS resultValueStr values(TestStepResult.testStepResultUnit) AS testStepResultUnit from datamodel=APDM_TestStepResults where (nodename = TestStepResult) TestStepResult.shortVIN="$tok_shortVIN$" TestStepResult.systemName="$tok_systemName$" TestStepResult.pruefumfangName="$tok_pruefumfangName$" TestStepResult.$tok_werk$ groupby source TestStepResult.testStand TestStepResult.testTime TestStepResult.resultName 
| eval resultVal=if(isNull(resultValueStr) OR resultValueStr="" OR resultValueStr="-", resultValueDbl, resultValueStr) 
| rename 
  TestStepResult.shortVIN AS shortVIN
  TestStepResult.systemName AS systemName
  TestStepResult.pruefumfangName AS pruefumfangName
  TestStepResult.testStand AS testStand
  TestStepResult.testTime AS testTime
  TestStepResult.resultName AS resultName
| append [
  | inputlookup lkup_appended_teststepresults
  | search shortVIN="$tok_shortVIN$" systemName="$tok_systemName$" pruefumfangName="$tok_pruefumfangName$"
]
| eval resultVal=if(isNull(resultValueStr) OR resultValueStr="" OR resultValueStr="-", resultValueDbl, resultValueStr) 
| eventstats 
  count(manFlag) AS modifiziert
  by source
| eval modifiziert=if(isNull(modifiziert) OR modifiziert=0, "nein", "ja")
| rename
  testStand AS Teststand
  testTime AS Testzeit
  resultName AS Ergebnisname
  resultVal AS Ergebniswert
  testStepResultUnit AS Einheit
  manFlag AS Manuell-Flag
| fields source Teststand Testzeit modifiziert Ergebnisname Ergebniswert Einheit Manuell-Flag 
    </query>
    <earliest>$tok_datetime.earliest$</earliest>
    <latest>$tok_datetime.latest$</latest>
  </search>
  <search id="exist_rn" base="pruefErg">
    <query>search "$i18n_Manuell-Flag$"=1 | fields "$i18n_Ergebnisname$" | dedup "$i18n_Ergebnisname$" | mvcombine delim="," "$i18n_Ergebnisname$"</query>
  </search>
  <fieldset submitButton="false">
    <input type="time" token="tok_datetime">
      <label>Zeit</label>
      <default>
        <earliest>-7d@h</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input id="input_werk" type="dropdown" token="tok_werk">
      <label>Werk</label>
      <prefix>werk="</prefix>
      <suffix>"</suffix>
    </input>
    <input type="dropdown" token="tok_systemName">
      <label>Systemname</label>
      <default>Achse</default>
      <fieldForLabel>systemName</fieldForLabel>
      <fieldForValue>systemName</fieldForValue>
      <search base="filter">
        <query>search $tok_werk$ | fields systemName | dedup systemName | sort systemName</query>
      </search>
      <change>
        <unset token="tok_click_src"></unset>
        <set token="tok_click_testStand"></set>
        <set token="tok_click_testTime"></set>
        <set token="tok_edit_id">0</set>
        <set token="tok_edit_man">0</set>
        <set token="tok_edit_resultName"></set>
        <set token="tok_edit_value"></set>
        <set token="tok_edit_unit"></set>
      </change>
    </input>
    <input type="dropdown" token="tok_pruefumfangName">
      <label>Pruefumfang</label>
      <fieldForLabel>pruefumfangName</fieldForLabel>
      <fieldForValue>pruefumfangName</fieldForValue>
      <search base="filter">
        <query>search $tok_werk$ systemName="$tok_systemName$" | fields pruefumfangName | dedup pruefumfangName | sort pruefumfangName</query>
      </search>
      <change>
        <unset token="tok_click_src"></unset>
        <set token="tok_click_testStand"></set>
        <set token="tok_click_testTime"></set>
        <set token="tok_edit_id">0</set>
        <set token="tok_edit_man">0</set>
        <set token="tok_edit_resultName"></set>
        <set token="tok_edit_value"></set>
        <set token="tok_edit_unit"></set>
      </change>
    </input>
    <input type="dropdown" token="tok_shortVIN">
      <label>FGNR</label>
      <fieldForLabel>shortVIN</fieldForLabel>
      <fieldForValue>shortVIN</fieldForValue>
      <search base="filter">
        <query>search $tok_werk$ systemName="$tok_systemName$" pruefumfangName=$tok_pruefumfangName$ |fields shortVIN | dedup shortVIN | sort shortVIN</query>
      </search>
      <change>
        <unset token="tok_click_src"></unset>
        <set token="tok_click_testStand"></set>
        <set token="tok_click_testTime"></set>
        <set token="tok_edit_id">0</set>
        <set token="tok_edit_man">0</set>
        <set token="tok_edit_resultName"></set>
        <set token="tok_edit_value"></set>
        <set token="tok_edit_unit"></set>
      </change>
    </input>
  </fieldset>
  <row>
    <panel>
      <title>Bestehende Pruefung</title>
      <table id="check">
        <search base="tests">
          <query>| table source Teststand Testzeit modifiziert | dedup source 
| rename 
  Teststand AS "$i18n_Teststand$"
  Testzeit AS "$i18n_Testzeit$"
  modifiziert AS "$i18n_modifiziert$"
          </query>
        </search>
        <option name="drilldown">cell</option>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>Pruefergebnisse</title>
      <html>
        <button id="addBtn" class="btn">$i18n_Hinzufuegen$</button>
        <button id="editBtn" class="btn">$i18n_Bearbeiten$</button>
        <button id="rmBtn" class="btn">$i18n_Entfernen$</button>
      </html>
      <table id="checkresults">
        <search base="tests" id="pruefErg">
          <query>search source="$tok_click_src$"
| sort Ergebnisname
| streamstats 
  count AS id
| eval mark=if($tok_edit_id$=id, 1, 0) 
| table Ergebnisname Ergebniswert Einheit Manuell-Flag mark id
| sort Manuell-Flag
| rename 
  Ergebnisname AS "$i18n_Ergebnisname$"
  Ergebniswert AS "$i18n_Ergebniswert$"
  Einheit AS "$i18n_Einheit$"
  Manuell-Flag AS "$i18n_Manuell-Flag$"</query>
        </search>
        <option name="drilldown">cell</option>
      </table>
    </panel>
  </row>
</form>