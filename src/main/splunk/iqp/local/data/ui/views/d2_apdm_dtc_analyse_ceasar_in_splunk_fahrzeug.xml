<form script="tabs/js/tabs.js, DTC/js/table_scroll.js, DTC/js/step_marker.js, DTC/js/db_fahrzeug.js" stylesheet="DTC/css/step_marker.css, tabs/css/tabs.css">
  <init>
    <set token="i18n_Fahrzeugdaten" i18ntag="">Fahrzeugdaten</set>
    <set token="i18n_Analyse" i18ntag="">Analyse</set>
    <set token="i18n_DTC_reset" i18ntag="">DTC Code zuruecksetzen</set>
    
    <set token="i18n_werk" i18ntag="">Werk</set>
    <set token="i18n_shortVIN" i18ntag="">FGNR</set>
    <set token="i18n_series" i18ntag="">Baureihe</set>
    <set token="i18n_vehicleType" i18ntag="">Fahrzeugtyp</set>
    <set token="i18n_integrationLevel" i18ntag="">I-Stufe</set>
    <set token="i18n_countryVariant" i18ntag="">Laendervariante</set>
    <set token="i18n_gearboxType" i18ntag="">LL/RL</set>
    <set token="i18n_typeKey" i18ntag="">Typschluessel</set>
    <set token="i18n_timeCriteria" i18ntag="">Zeitkriterium</set>
    <set token="i18n_driveType" i18ntag="">DriveTyp</set>
    <set token="i18n_driveConfiguration" i18ntag="">DriveKonfig</set>
    
    <set token="i18n_Fahrzeuginfo" i18ntag="">Fahrzeuginfo</set> 
    <set token="i18n_Wert" i18ntag="">Wert</set>
    
    <set token="i18n_engineNumber" i18ntag="">Motornummer</set>
    <set token="i18n_engineFamily" i18ntag="">Motorfamilie</set>
    <set token="i18n_engineSeries" i18ntag="">Motorbaureihe</set> 
    <set token="i18n_engineDerivative" i18ntag="">Derivat</set>
    
    <set token="i18n_code" i18ntag="">Code</set> 
    <set token="i18n_description" i18ntag="">Beschreibung</set>
    
    <set token="i18n_testTime" i18ntag="">Uhrzeit</set>
    <set token="i18n_pruefumfangName" i18ntag="">Pruefumfang</set>
    <set token="i18n_testStand" i18ntag="">Pruefstand</set>
    <set token="i18n_complete" i18ntag="">PU komplett</set>
    <set token="i18n_errorCount" i18ntag="">PU Fehler</set>
    <set token="i18n_zfs_fehler" i18ntag="">ZFS Fehler</set>
    <set token="i18n_testDuration" i18ntag="">Dauer</set>
    
    <set token="i18n_dtcCode" i18ntag="">DTC-Code</set>
    <set token="i18n_dtcText" i18ntag="">DTC-Text</set>
    <set token="i18n_Event" i18ntag="">Event</set>
    <set token="i18n_Zeitpunkt" i18ntag="">Zeitpunkt</set>
    <set token="i18n_dtcTime" i18ntag="">Systemzeit</set>
    <set token="i18n_dtcAddress" i18ntag="">SG Adresse</set>
    <set token="i18n_dtcSGBD" i18ntag="">SGBD</set>
    
    <set token="i18n_sequenceNrResult" i18ntag="">Sequenz</set>
    <set token="i18n_testStepDuration" i18ntag="">Schrittdauer</set>
    <set token="i18n_testStepResult" i18ntag="">Testergebnis</set>
    <set token="i18n_errorType" i18ntag="">Fehlertyp</set>
    <set token="i18n_param1" i18ntag="">SGBD</set>
    <set token="i18n_param2" i18ntag="">API-Job</set>
    <set token="i18n_param3" i18ntag="">Job-Parameter</set>
    <set token="i18n_resultName" i18ntag="">Ergebnisname</set>
    <set token="i18n_resultValueStr" i18ntag="">Ergebnis (Text)</set>
    <set token="i18n_resultValueDbl" i18ntag="">Ergebnis (Zahl)</set>
    <set token="i18n_errorText" i18ntag="">Fehlermeldung</set>
  </init>
  <label>D2.1-APDM DTC-Analyse (Ceasar in Splunk)/ Fahrzeuganalyse</label>
  <search id="base_vehicleData">
    <query>| tstats 
    count 
    values(OrderData.engineNumber) as engineNumber
    values(OrderData.engineFamily) as engineFamily
    values(OrderData.saCode) as saCodes
  from datamodel=APDM_OrderData_Events 
  where (nodename = OrderData) OrderData.shortVIN=$shortVIN$
  groupBy OrderData.werk OrderData.shortVIN OrderData.series OrderData.vehicleType OrderData.integrationLevel OrderData.countryVariant OrderData.gearboxType OrderData.typeKey OrderData.timeCriteria OrderData.driveType OrderData.driveConfiguration OrderData.engineSeries OrderData.engineDerivative</query>
    <earliest></earliest>
    <latest></latest>
  </search>
  <!-- DTC CODE FOLLOWS -->
  <fieldset submitButton="false"></fieldset>
  <row id="tabs">
    <panel>
      <html>
				<ul class="nav nav-tabs" id="tabs">
					<li class="active">
						<a href="#" class="toggle-tab" data-token="tab1_clicked" data-elements="vehData1,vehData2" data-toggle="tab">$i18n_Fahrzeugdaten$</a>
					</li>
					<li>
						<a href="#" class="toggle-tab" data-token="tab2_clicked" data-elements="dtcData1,dtcData2" data-toggle="tab">$i18n_Analyse$</a>
					</li>
				</ul>
			</html>
    </panel>
  </row>
  <row id="vehData1">
    <panel>
      <table>
        <title></title>
        <search base="base_vehicleData">
          <query>| fields OrderData.werk OrderData.shortVIN OrderData.series OrderData.vehicleType OrderData.integrationLevel OrderData.countryVariant OrderData.gearboxType OrderData.typeKey OrderData.timeCriteria OrderData.driveType OrderData.driveConfiguration
| rename 
  OrderData.werk AS "$i18n_werk$"
  OrderData.shortVIN AS "$i18n_shortVIN$"
  OrderData.series AS "$i18n_series$"
  OrderData.vehicleType AS "$i18n_vehicleType$"
  OrderData.integrationLevel AS "$i18n_integrationLevel$"
  OrderData.countryVariant AS "$i18n_countryVariant$"
  OrderData.gearboxType AS "$i18n_gearboxType$"
  OrderData.typeKey AS "$i18n_typeKey$"
  OrderData.timeCriteria AS "$i18n_timeCriteria$"
  OrderData.driveType AS "$i18n_driveType$"
  OrderData.driveConfiguration AS "$i18n_driveConfiguration$"
| transpose 
| rename 
  column AS "$i18n_Fahrzeuginfo$"
  "row 1" AS "$i18n_Wert$"</query>
        </search>
        <option name="rowNumbers">false</option>
        <option name="drilldown">none</option>
        <option name="dataOverlayMode">none</option>
        <option name="count">20</option>
      </table>
    </panel>
    <panel>
      <table>
        <title>Motor</title>
        <search base="base_vehicleData">
          <query>| fields engineNumber engineFamily OrderData.engineSeries OrderData.engineDerivative 
| rename 
  engineNumber as "$i18n_engineNumber$"
  engineFamily as "$i18n_engineFamily$"
  OrderData.engineSeries as "$i18n_engineSeries$"
  OrderData.engineDerivative as "$i18n_engineDerivative$"</query>
        </search>
        <option name="drilldown">none</option>
        <option name="rowNumbers">false</option>
      </table>
    </panel>
  </row>
  <row id="vehData2">
    <panel>
      <table id="saCodeTable">
        <title>Sonderausstattung(en)</title>
        <search base="base_vehicleData">
          <query>| fields saCodes
| mvexpand saCodes 
| lookup sa_translation CODE as saCodes OUTPUT DESCRIPTIONDE as "$i18n_description$"
| rename 
  saCodes as "$i18n_code$"</query>
        </search>
        <option name="drilldown">none</option>
        <option name="rowNumbers">false</option>
        <option name="count">50</option>
      </table>
    </panel>
  </row>
  <row id="dtcData1">
    <panel>
      <title>Ausgeführte Prüfumfänge</title>
      <table id="highlight">
        <search id="sub_pruefUmfang">
          <query>
| union
[
  search index=apdm sourcetype=apdm_test_result $shortVIN$ shortVIN=$shortVIN$
| eval last_test_source=source
| fields pruefumfangName _time testStand complete errorCount testDuration last_test_source
| rename _time as testTime
]
[
  search index=dtc_summary $shortVIN$ shortVIN=$shortVIN$ NOT dtcCode="-"
| dedup pruefumfangName dtcTime dtcAddress dtcCode 
| fields pruefumfangName testTime last_test_source dtcCode
| eval zfs_fehler="true"
]
| eval testTime=strftime(tonumber(testTime), "%Y-%m-%d %H:%M:%S.%3N")
| stats count(zfs_fehler) as zfs_fehler values(testStand) as testStand values(complete) as complete values(errorCount) as errorCount values(testDuration) as testDuration values(dtcCode) as dtcCode values(last_test_source) as last_test_source by pruefumfangName testTime
| fillnull value="-" testStand complete errorCount testDuration last_test_source
| stats max(eval(if($dtcCodeHighlight$,1,null()))) as mark, values(zfs_fehler) as zfs_fehler
  by testTime pruefumfangName testStand complete errorCount testDuration last_test_source 
| eval last_test_source2=replace(last_test_source, "\\\\", "\\\\\\\\")
| eval pruefUmfangToken="pruefumfangName=\"" + pruefumfangName + "\" AND source=\"" + last_test_source2 + "\""
| table testTime pruefumfangName testStand complete errorCount zfs_fehler testDuration last_test_source mark pruefUmfangToken
| rename
  testTime AS "$i18n_testTime$"
  pruefumfangName AS "$i18n_pruefumfangName$"
  testStand AS "$i18n_testStand$"
  complete AS "$i18n_complete$"
  errorCount AS "$i18n_errorCount$"
  zfs_fehler AS "$i18n_zfs_fehler$"
  testDuration AS "$i18n_testDuration$"
  last_test_source AS source
</query>
<!-- nicht: | eval Uhrzeit=strftime(Uhrzeit, "%Y-%m-%d %H:%M:%S.%3N") -->
        </search>
        <option name="dataOverlayMode">none</option>
        <option name="rowNumbers">false</option>
        <format type="color" field="$i18n_errorCount$">
          <colorPalette type="list">[#A2CC3E,#D93F3C]</colorPalette>
          <scale type="threshold">1</scale>
        </format>
        <format type="color" field="$i18n_zfs_fehler$">
          <colorPalette type="list">[#A2CC3E,#D93F3C]</colorPalette>
          <scale type="threshold">1</scale>
        </format>
        <format type="color" field="$i18n_complete$">
          <colorPalette type="map">{"nein":#D93F3C}</colorPalette>
        </format>
        <drilldown>
          <!--set token="form.selectedPU"> $row.pruefUmfangToken$</set-->
          <set token="pruefUmfang"></set>
          <set token="stepTime">0</set>
        </drilldown>
      </table>
    </panel>
    <panel>
      <title>Zentraler Fehlerspeicher Einträge</title>
      <input type="multiselect" id="selectedPU" searchWhenChanged="true" token="selectedPU">
        <label>Ausgewählte Prüfumfänge:</label>
        <search base="sub_pruefUmfang">
          <query>| fields "$i18n_pruefumfangName$" pruefUmfangToken</query>
        </search>
        <valuePrefix>(</valuePrefix>
        <valueSuffix>)</valueSuffix>
        <delimiter> OR </delimiter>
        <allowCustomValues>true</allowCustomValues>
        <fieldForLabel>$i18n_pruefumfangName$</fieldForLabel>
        <fieldForValue>pruefUmfangToken</fieldForValue>
        <change>
          <set token="pruefUmfang"></set>
          <set token="stepTime">0</set>
        </change>
      </input>
      <table id="table_dtcs">
        <search>
          <query>
search index=dtc_summary $shortVIN$ shortVIN=$shortVIN$ NOT dtcCode="-"
| dedup pruefumfangName dtcTime dtcAddress dtcCode 
| fields pruefumfangName testTime last_test_source dtcCode dtcTime dtcAddress dtcSGBD dtcText _time
| stats
    values(testStand) as testStand 
    values(complete) as complete 
    values(errorCount) as errorCount 
    values(testDuration) as testDuration 
    values(dtcAddress) as dtcAddress 
    values(dtcSGBD) as dtcSGBD 
    values(dtcText) as dtcText
    values(_time) as testStepTime
    values(last_test_source) as source 
by pruefumfangName dtcCode dtcTime
| eval Event=if(dtcAddress="FF", "CC", "DTC")
| search $selectedPU$
| where isNotNull(dtcCode)
| eval 
  Zeitpunkt=strftime(testStepTime, "%Y-%m-%d %H:%M:%S.%3N"), 
  mark=if($dtcCodeHighlight$,1,null())
| table dtcCode dtcText Event pruefumfangName Zeitpunkt dtcTime dtcAddress dtcSGBD testStepTime mark
| rename 
  dtcCode AS "$i18n_dtcCode$"
  dtcText AS "$i18n_dtcText$"
  Event AS "$i18n_Event$"
  pruefumfangName AS "$i18n_pruefumfangName$"
  Zeitpunkt AS "$i18n_Zeitpunkt$"
  dtcTime AS "$i18n_dtcTime$"
  dtcAddress AS "$i18n_dtcAddress$"
  dtcSGBD AS "$i18n_dtcSGBD$"
          </query>
        </search>
        <option name="rowNumbers">false</option>
        <option name="dataOverlayMode">none</option>
        <option name="count">10</option>
        <option name="dataOverlayMode">none</option>
        <option name="rowNumbers">false</option>
        <option name="drilldown">cell</option>
      </table>
    </panel>
  </row>
  <row id="dtcData2">
    <panel>
      <title>Ausgeführte Prüfschritte</title>
      <html>
        <input type="text" id="selectedPUS" style="margin-bottom: 0;" readonly="true"/>
        <button type="button" id="reset_DTC_button" class="btn">$i18n_DTC_reset$</button>
      </html>
      <table id="testSteps">
        <search id="teststeps">
          <query>index=apdm $selectedPU$ $shortVIN$ shortVIN=$shortVIN$ sourcetype="apdm_test_step_result"  
| sort _time
| eval  
  Zeitpunkt=strftime(_time, "%Y-%m-%d %H:%M:%S.%3N"),
  maxStepTime=_time+(testStepDuration/1000),
  mark=if(pruefumfangName="$pruefUmfang$" AND _time&lt;=$stepTime$ AND maxStepTime&gt;=$stepTime$, 1, 0)
| eventstats 
  sum(mark) AS sumMark
  max(eval(if(mark=1, maxStepTime+2, null()))) AS maxTime
  min(eval(if(mark=1, _time-2, null()))) AS minTime
| where sumMark=0 OR (minTime &lt;= maxStepTime AND maxTime &gt;= _time)
| table sequenceNrResult pruefumfangName Zeitpunkt testStepDuration testStepResult errorType description param1 param2 param3 resultName resultValueStr resultValueDbl errorText mark
| rename
  sequenceNrResult AS "$i18n_sequenceNrResult$"
  pruefumfangName AS "$i18n_pruefumfangName$"
  Zeitpunkt AS "$i18n_Zeitpunkt$"
  testStepDuration AS "$i18n_testStepDuration$"
  testStepResult AS "$i18n_testStepResult$"
  errorType AS "$i18n_errorType$"
  description AS "$i18n_description$"
  param1 AS "$i18n_param1$"
  param2 AS "$i18n_param2$"
  param3 AS "$i18n_param3$"
  resultName AS "$i18n_resultName$"
  resultValueStr AS "$i18n_resultValueStr$"
  resultValueDbl AS "$i18n_resultValueDbl$"
  errorText AS "$i18n_errorText$"
| sort Prüfumfang Sequenz
          </query>
          <earliest>$el$</earliest>
          <latest>$la$</latest>
        </search>
        <option name="rowNumbers">false</option>
        <option name="drilldown">none</option>
        <option name="rowNumbers">false</option>
        <option name="dataOverlayMode">none</option>
        <option name="count">25</option>
      </table>
    </panel>
  </row>
</form>